<!DOCTYPE html>
<html class="wide wow-animation" lang="en">

<head>
  <!-- Site Title-->
  <title>Admin</title>
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta charset="utf-8">
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Oswald:200,400%7CLato:300,400,300italic,700%7CMontserrat:900">
  <link rel="stylesheet" href="/stylesheets/style2.css">
  <link rel="stylesheet" href="/stylesheets/bootstrap.css">
  <link rel="stylesheet" href="/stylesheets/style.css">
  <link rel="stylesheet" href="/stylesheets/fonts.css">
  <link rel="stylesheet" href="/stylesheets/style1.css">
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
  <link rel="stylesheet" href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" type="text/css">
  <link href="/stylesheets/calender.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" href="/stylesheets/adminstyle.css">
  <link rel="stylesheet" href="/stylesheets/admin.css">


  <!--[if lt IE 10]>
    <div style="background: #212121; padding: 10px 0; box-shadow: 3px 3px 5px 0 rgba(0,0,0,.3); clear: both; text-align:center; position: relative; z-index:1;"><a href="http://windows.microsoft.com/en-US/internet-explorer/"><img src="images/ie8-panel/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today."></a></div>
    <script src="js/html5shiv.min.js"> </script>
		<![endif]-->
</head>

<body>


  <header class="section page-header">
    <!-- RD Navbar-->
    <div class="rd-navbar-wrap rd-navbar-corporate">
      <nav class="rd-navbar" data-layout="rd-navbar-fixed" data-sm-layout="rd-navbar-fixed" data-md-layout="rd-navbar-fixed" data-md-device-layout="rd-navbar-fixed" data-lg-layout="rd-navbar-fullwidth" data-xl-layout="rd-navbar-static"
        data-lg-device-layout="rd-navbar-fixed" data-xl-device-layout="rd-navbar-static" data-md-stick-up-offset="130px" data-lg-stick-up-offset="100px" data-stick-up="true" data-sm-stick-up="true" data-md-stick-up="true" data-lg-stick-up="true"
        data-xl-stick-up="true">
        <div class="rd-navbar-collapse-toggle" data-rd-navbar-toggle=".rd-navbar-collapse"><span></span></div>

        <!--
            <div class="rd-navbar-top-panel rd-navbar-collapse novi-background">
              <div class="rd-navbar-top-panel-inner">
                <ul class="list-inline">

                  <li class="box-inline list-inline-item">
                    <ul class="list-comma log-sign-button">
                      <li><a class="button button-sm button-nina login-button" href="login.html">login</a></li>
                      <li></li>
                    </ul>
                  </li>
                  <li class="box-inline list-inline-item"><span class="icon novi-icon icon-md-smaller icon-secondary mdi mdi-map-marker"></span><a href="#">2130 Fulton Street, San Diego, CA 94117-1080 USA</a></li>
                  <li class="box-inline list-inline-item"><span class="icon novi-icon icon-md-smaller icon-secondary mdi mdi-email"></span><a href="mailto:#">mail@demolink.org</a></li>
                </ul>
                <ul class="list-inline">
                  <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-facebook" href="#"></a></li>
                  <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-twitter" href="#"></a></li>
                  <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-instagram" href="#"></a></li>
                  <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-google-plus" href="#"></a></li>
                  <li class="list-inline-item"><a class="icon novi-icon icon-sm-bigger icon-gray-1 mdi mdi-linkedin" href="#"></a></li>
                </ul>
              </div>
            </div>
-->


        <div class="rd-navbar-inner">
          <!-- RD Navbar Panel-->
          <div class="rd-navbar-panel">
            <!-- RD Navbar Toggle-->
            <button class="rd-navbar-toggle" data-rd-navbar-toggle=".rd-navbar-nav-wrap"><span></span></button>
            <!-- RD Navbar Brand-->
            <div class="rd-navbar-brand">
              <a class="brand-name" href="/">


                <img class="logo-default" src="/images/quickecab-logo.png" alt="" width="100px" height="26px" />
                <!--                            <img class="logo-inverse" src="images/logo-inverse-208x46.png" alt="" width="208" height="46" />-->

              </a>
            </div>
          </div>
          <div class="rd-navbar-aside-center">
            <div class="rd-navbar-nav-wrap">
              <!-- RD Navbar Nav-->
              <ul class="rd-navbar-nav">
                <li class="active"><a href="/admin">Admin</a>
                </li>
                <!--                                <li><a href="about-us.html">About Us</a></li>-->
                <!--                                <li><a href="contacts.html">Contacts</a></li>-->
                <li>
                  <form action="/users/logout" method="post">
                    <div class="rd-navbar-aside-right login-button ml-auto"><button type="submit" class="button button-sm button-nina " href="/users/logout">logout</button></div>
                  </form>
                </li>


              </ul>
            </div>
          </div>
          <!--
                    <div class="log-sign-button">
                        <div class="rd-navbar-aside-right login-button"><a class="button button-sm button-nina " href="#">logout</a></div>
                        <div class="rd-navbar-aside-right signup-button"><a class="button button-sm button-secondary button-nina " href="signup.html">signUP</a></div>
                    </div>
-->


        </div>
      </nav>
    </div>
  </header>

  <div class="admin-panel">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="true">Bookings pending</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="false">Bookings confirmed</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">car's Detail</a>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
        <% for(let i=0; i<pending_bookings.length; i++) { %>
          <div class="card w-70 bookings-card I<%= pending_bookings[i].Id %>" >
            <h6 class="card-title booking-id">Booking ID:&nbsp; <span><%= pending_bookings[i].Id %></span></h6>
            <div class="card-body ">


              <div class="leftbody ">
                <p class="card-text username"> UserName:&nbsp; <span><%= pending_bookings[i].user_name %></span></p>
                <p class="card-text trip-type">TripType: &nbsp;<%= pending_bookings[i].journey %></p>
                <p class="card-text trip">Trip:&nbsp; From &nbsp;<span> <%= pending_bookings[i].destination_from %> </span>&nbsp;to &nbsp;<span> <%= pending_bookings[i].destination_to.split('$').join(' --> TO --> ') %> </span></p>

              </div>
              <div class="rightbody ">
                <p class="card-text trip-date">TripDate:&nbsp; From &nbsp;<span> <%= pending_bookings[i].start_date %> </span> &nbsp;to &nbsp;<span> <%= pending_bookings[i].end_date %> </span></p>
                <p class="card-text car-selected">Car Selected:&nbsp; <span><%= pending_bookings[i].name %></span></p>
                <p class="card-text car-selected">Total Fare:&nbsp; <span>Rs <%= pending_bookings[i].fare %></span></p>
              </div>

            </div>
            <!--                    <a href="#" class="btn btn-primary confirm-btn ">confirm</a>-->
            <!-- Button trigger modal -->
            <button type="button" class="btn btn-primary confirm-btn" data-toggle="modal" data-target="#I<%= pending_bookings[i].Id %>">
              confirm
            </button>

            <!-- Modal -->
            <div class="modal fade" id="I<%= pending_bookings[i].Id %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Confirm Booking</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <p class="card-text booking-id">Booking ID:&nbsp; <span><%= pending_bookings[i].Id %></span></p>
                    <p class="card-text username"> UserName:&nbsp; <span><%= pending_bookings[i].user_name %></span></p>
                    <p class="card-text trip-type">TripType: &nbsp;<%= pending_bookings[i].journey %></p>
                    <p class="card-text trip">Trip:&nbsp; From &nbsp;<span><%= pending_bookings[i].destination_from %></span> &nbsp;to &nbsp;<span> london </span></p>
                    <p class="card-text trip-date">TripDate:&nbsp; <span><%= pending_bookings[i].start_date %></span></p>
                    <p class="card-text car-selected">Car Selected:&nbsp; <span><%= pending_bookings[i].name %></span></p>


                    <div class="container car-container">

                      <!-- <form method="post" action="/"> -->
                        <div class="form-group car-selected">
                          <p class="card-text car-number">Car number:&nbsp;</p>
                          <input type="text" name="carNumber" required>
<!--
                          <select class="form-control" id="sel1">
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>

                          </select>
-->
                          <br>

                        </div>
                      <!-- </form> -->
                    </div>



                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary but" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary but" onclick="acceptBooking('<%= pending_bookings[i].Id %>', '<%= pending_bookings[i].user_mail %>')">Send confirmation</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } %>

        </div>
      <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
        <% if(bookings.length === 0) { %>
          <h2>No bookings in progress</h2>
        <% } %>
        <% for(let i=0; i<bookings.length; i++) { %>
        <div class="card w-70 bookings-card">
          <h6 class="card-title booking-id">Booking ID:&nbsp; <span><%= bookings[i].Id %></span></h6>
          <div class="card-body ">


            <div class="leftbody ">
              <p class="card-text username"> UserName:&nbsp; <span><%= bookings[i].user_name %></span></p>
              <p class="card-text trip-type">TripType: &nbsp;<%= bookings[i].journey %></p>
              <p class="card-text trip">Trip:&nbsp; From &nbsp;<span> <%= bookings[i].destination_from %> </span> &nbsp;to &nbsp;<span> <%= bookings[i].destination_to %> </span></p>
              <p class="card-text car-selected">Fare:&nbsp; <span><%= bookings[i].fare %></span></p>

            </div>
            <div class="rightbody ">
              <p class="card-text trip-date">TripDate:&nbsp; <span><%= bookings[i].start_date %></span></p>
              <p class="card-text car-selected">Car Selected:&nbsp; <span><%= bookings[i].name %></span></p>
              <p class="card-text trip-type">Car Number: &nbsp;<%= (bookings[i].car_number == 'undefined')?'Not Available':bookings[i].car_number %></p>

              <!-- <p class="card-text car-number">Car Number:&nbsp; <span><%= bookings[i].vehicle_number %></span></p> -->

            </div>

          </div>
          <button href="#" class="btn btn-primary confirm-btn" id="<%= bookings[i].Id %>" onclick="endTrip(id)">End Trip</button>

        </div>
        <% } %>
      </div>
      <div class="tab-pane fade contact1" id="contact" role="tabpanel" aria-labelledby="contact-tab">
        <% for(let i=0; i<cars.length; i++) { %>
        <div class="paeg">
          <div class="card border-light">
            <div class="card-header"><a><%= cars[i].name %></a></div>
            <div class="card-body">
              <!-- <a class="card-title">Car no. :- <%= cars[i].Number %></a> -->
              <div class="card-text">
                seats :- <%= cars[i].seats %>
                <!-- Driver :- XYZ KUMAR -->
                <!-- <br>
                Phone no. :- 8567256345 -->
              </div>
                <button type="button" class="btn btn-primary ml-auto" name="<%= cars[i].name %>" onclick='toggleAvailability(name)'>
                <%= cars[i].availability?'Unavailable':'Available' %>
              </button>
            </div>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Global Mailform Output-->
  <div class="snackbars" id="form-output-global"> </div>
  <!-- Javascript-->
  <script src="/js/core.min.js"></script>
  <script src="/js/script.js"></script>


  <!-- xml requests section for realtime updation -->
  <script type="text/javascript" >


    function acceptBooking(id, user_mail) {

      console.log("acceptBooking called");

      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log("post request sent and returned with status:", this.responseText);
          if(this.responseText === '1') {
            console.log(`booking of id=${id} accepted and in progress`);
            
            window.location.href = "http://"+"<%= url + '/admin' %>"
          }
          if(this.responseText === 'Mail Error') {
            //alert
          }
        }
      };

      var carNumber = document.querySelector(`.I${id} input`).value;
      console.log(carNumber);
      if(!carNumber) {
        return;
      }

      xhttp.open("POST", "/admin/acceptBooking", true);
      console.log("post request sent");
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send(`id=${id}&email=${user_mail}&carNumber=${carNumber}`);
    }

    function endTrip(id) {
      var xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        console.log("ready state:", this.readyState);
        if (this.readyState == 4 && this.status == 200) {
          console.log("post request sent and returned with status:", this.responseText);
          if(this.responseText === '1') {
            console.log(`trip of booking id=${id} ended`);
            window.location.href = "http://"+"<%= url + '/admin' %>"
          }
        }
      };
      xhttp.open("POST", "/admin/endTrip", true);
      console.log("post request sent");
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send(`id=${id}`);

    }

    function toggleAvailability(name) {

      var xhttp = new XMLHttpRequest;
      xhttp.onreadystatechange = function() {
        console.log("ready state:", this.readyState);
        if (this.readyState == 4 && this.status == 200) {
          console.log("post request sent and returned with status:", this.responseText);

          if(this.responseText === '1') {
            console.log(`car: ${name} availability toggled`);
            window.location.href = "http://"+"<%= url + '/admin' %>"
          }
        }
      };
      xhttp.open("POST", "/admin/toggleAvailability", true);
      console.log("post request sent for car:", name);
      xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      xhttp.send(`name=${name}`);

    }

  </script>

</body>

</html>
